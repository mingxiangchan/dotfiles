---
- name: install rbenv
  git:
    repo: "https://github.com/rbenv/rbenv.git"
    dest: ~/.rbenv

- name: ensure rbenv is loaded in env
  lineinfile:
    path: ~/.zshrc
    line: 'export PATH="$HOME/.rbenv/bin:$PATH"'

- name: ensure rbenv is loaded in env
  lineinfile:
    path: ~/.zshrc
    line: 'eval "$(rbenv init -)"'

- name: install ruby-build
  git:
    repo: "https://github.com/rbenv/ruby-build.git"
    dest: ~/.rbenv/plugins/ruby-build

- name: ensure ruby-build is loaded
  lineinfile:
    path: ~/.zshrc
    line: 'export PATH="$HOME/.rbenv/plugins/ruby-build/bin:$PATH"'

- name: check installed ruby versions
  raw: ~/.rbenv/bin/rbenv versions --bare
  register: installed_ruby_versions

- name: install specified ruby version
  raw: "~/.rbenv/bin/rbenv install {{ ruby_version }}"
  when: ruby_version not in installed_ruby_versions.stdout_lines

- name: use specified ruby version globally
  raw: "~/.rbenv/bin/rbenv global {{ ruby_version }}"
